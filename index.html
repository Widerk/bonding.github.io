<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluid Shape Pro | Bonding Shoes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f1a;
            --card: #161c2d;
            --accent: #3b82f6;
            --input-bg: #1e293b;
        }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg); 
            color: #e2e8f0;
            overflow: hidden;
        }
        
        .glass {
            background: rgba(22, 28, 45, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Ocultar flechas de input number */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .input-group {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }
        .input-group:focus-within {
            border-color: var(--accent);
            background: rgba(30, 41, 59, 0.8);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .list-item-active {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .btn-stepper {
            color: #64748b;
            transition: color 0.2s;
        }
        .btn-stepper:hover {
            color: #3b82f6;
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-soft {
            animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="p-4 lg:p-6 h-screen flex flex-col">
    <div class="max-w-[1800px] mx-auto w-full flex-grow flex flex-col gap-6">
        
        <!-- Navbar -->
        <nav class="flex items-center justify-between glass rounded-2xl px-6 py-3">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                    <i data-lucide="layers" class="text-white w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-sm font-extrabold tracking-widest text-blue-400 uppercase">Bonding Shoes Manager</h1>
                </div>
            </div>
            <div class="flex gap-3 items-center">
                <!-- Botón Sobrescribir (Solo visible si hay un item seleccionado) -->
                <button id="btn-overwrite" onclick="overwriteCurrentShape()" class="hidden flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-emerald-900/20">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualizar Registro
                </button>
                
                <button onclick="saveCurrentShape()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-xl text-xs font-bold transition-all shadow-lg shadow-blue-900/20">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Nuevo Perfil
                </button>
            </div>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow overflow-hidden">
            
            <!-- IZQUIERDA: Parámetros de Diseño -->
            <aside class="lg:col-span-3 flex flex-col gap-6 overflow-hidden">
                <div class="glass rounded-3xl p-6 flex flex-col overflow-hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <i data-lucide="settings-2" class="w-5 h-5 text-blue-400"></i>
                            <h2 class="text-[11px] font-black text-white uppercase tracking-widest">Parámetros</h2>
                        </div>
                        <div id="editing-indicator" class="hidden flex items-center gap-1.5 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse-soft"></span>
                            <span class="text-[9px] font-bold text-emerald-500 uppercase">Editando</span>
                        </div>
                    </div>

                    <div id="numeric-controls" class="space-y-4 overflow-y-auto custom-scrollbar pr-2">
                        <!-- Generado por JS -->
                    </div>

                    <div class="mt-8 pt-6 border-t border-white/5">
                        <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3">Material / Fluido</p>
                        <select id="material-select" class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-3 text-xs text-slate-300 outline-none focus:border-blue-500 transition-all appearance-none cursor-pointer">
                            <option value="1121.7">Personalizado (1121.7 kg/m³)</option>
                            <option value="1000">Agua Dulce (1000 kg/m³)</option>
                            <option value="1025">Agua Salada (1025 kg/m³)</option>
                            <option value="920">Aceite (920 kg/m³)</option>
                        </select>
                    </div>
                </div>
            </aside>

            <!-- CENTRO: Visualización -->
            <div class="lg:col-span-6 flex flex-col gap-6 overflow-hidden">
                <div id="main-display" class="glass rounded-[2.5rem] p-2 border border-white/10 relative flex flex-col flex-grow bg-[#050810] transition-all duration-300">
                    <div id="canvasContainer" class="flex-grow flex items-center justify-center relative overflow-hidden">
                        <svg id="svgMain" viewBox="0 0 300 300" class="w-[85%] h-[85%]" style="transform: scaleY(-1);">
                            <defs>
                                <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#1e293b" stroke-width="0.3"/>
                                </pattern>
                            </defs>
                            <rect x="-1000" y="-1000" width="2000" height="2000" fill="url(#grid)" />
                            <polygon id="shapePoly" fill="rgba(59, 130, 246, 0.15)" stroke="#3b82f6" stroke-width="2.5" stroke-linejoin="round" />
                            <g id="cotasGroup"></g>
                            <circle id="centroid" r="4.5" fill="#f43f5e" stroke="#fff" stroke-width="2" />
                        </svg>
                    </div>
                    
                    <div class="p-6 flex justify-between items-center bg-slate-900/30 rounded-b-[2.3rem]">
                        <div class="flex gap-4">
                            <div class="flex flex-col">
                                <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Área Sección</span>
                                <span class="font-mono text-sm font-bold text-white"><span id="m-area">0</span> mm²</span>
                            </div>
                            <div class="w-px h-8 bg-white/10"></div>
                            <div class="flex flex-col">
                                <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Masa Est.</span>
                                <span class="font-mono text-sm font-bold text-emerald-400"><span id="m-mass">0.000</span> kg</span>
                            </div>
                        </div>
                        <button onclick="toggleFullscreen()" class="p-2.5 bg-white/5 hover:bg-white/10 rounded-xl transition-all text-slate-400 hover:text-white">
                            <i id="fs-icon" data-lucide="maximize" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- DERECHA: Bonding Shoes (Lista) -->
            <aside class="lg:col-span-3 flex flex-col overflow-hidden">
                <div class="glass rounded-3xl p-6 flex flex-col h-full">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <i data-lucide="bookmark" class="w-5 h-5 text-blue-400"></i>
                            <h2 class="text-[11px] font-black text-white uppercase tracking-widest">Bonding Shoes</h2>
                        </div>
                        <span id="list-count" class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-blue-400 font-bold font-mono">0</span>
                    </div>
                    
                    <div id="shape-list" class="flex-grow overflow-y-auto custom-scrollbar space-y-3 pr-2">
                        <div class="text-center py-20 text-slate-700 italic text-xs">No hay registros guardados</div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal para Nuevo Registro -->
    <div id="save-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-4">
        <div class="bg-[#161c2d] border border-white/10 rounded-[2rem] p-8 max-w-sm w-full shadow-2xl">
            <div class="w-12 h-12 bg-blue-600/20 rounded-2xl flex items-center justify-center mb-6">
                <i data-lucide="save" class="text-blue-500 w-6 h-6"></i>
            </div>
            <h3 class="text-xl font-extrabold text-white mb-2">Nuevo Perfil</h3>
            <p class="text-slate-400 text-sm mb-6 leading-relaxed">Asigna un nombre para identificar este registro.</p>
            <input type="text" id="shape-name-input" placeholder="Nombre del perfil..." class="w-full bg-slate-900 border border-white/10 rounded-xl px-4 py-4 text-white text-sm outline-none focus:border-blue-500 transition-all mb-8">
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 px-4 py-3.5 rounded-xl bg-slate-800 text-slate-300 font-bold text-xs hover:bg-slate-700 transition-all">Cancelar</button>
                <button onclick="confirmSave()" class="flex-1 px-4 py-3.5 rounded-xl bg-blue-600 text-white font-bold text-xs hover:bg-blue-500 transition-all">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        let params = { A: 104, B: 40, C: 17, D: 20, E: 52 };
        const labelsMap = { 
            A: { full: 'Base (A)', short: 'BASE' }, 
            B: { full: 'Pico (B)', short: 'PICO' }, 
            C: { full: 'Alt. Izq (C)', short: 'ALTL' }, 
            D: { full: 'Alt. Der (D)', short: 'ALTR' }, 
            E: { full: 'Pos. Pico (E)', short: 'POSE' } 
        };
        
        let savedShapes = [];
        let activeShapeId = null;

        function init() {
            lucide.createIcons();
            renderNumericControls();
            loadFromStorage();
            updateCalculations();
            document.getElementById('material-select').addEventListener('change', updateCalculations);
        }

        function renderNumericControls() {
            const container = document.getElementById('numeric-controls');
            container.innerHTML = '';
            
            Object.keys(params).forEach(key => {
                const group = document.createElement('div');
                group.className = 'flex flex-col gap-2';
                group.innerHTML = `
                    <div class="flex justify-between items-center px-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">${labelsMap[key].full}</label>
                    </div>
                    <div class="input-group flex items-center rounded-xl overflow-hidden px-4 py-2">
                        <input type="number" 
                            id="input-${key}"
                            value="${params[key]}" 
                            oninput="updateParamValue('${key}', this.value)"
                            class="flex-grow bg-transparent text-blue-400 font-mono text-base font-bold outline-none"
                        >
                        <div class="flex items-center gap-2 border-l border-white/5 pl-4 ml-2">
                            <div class="flex flex-col">
                                <button onclick="step('${key}', 1)" class="btn-stepper"><i data-lucide="chevron-up" class="w-3.5 h-3.5"></i></button>
                                <button onclick="step('${key}', -1)" class="btn-stepper"><i data-lucide="chevron-down" class="w-3.5 h-3.5"></i></button>
                            </div>
                            <span class="text-[10px] font-black text-slate-600">MM</span>
                        </div>
                    </div>
                `;
                container.appendChild(group);
            });
            lucide.createIcons();
        }

        function updateParamValue(key, val) {
            params[key] = parseFloat(val) || 0;
            updateCalculations();
        }

        function step(key, amount) {
            params[key] = Math.max(0, params[key] + amount);
            document.getElementById(`input-${key}`).value = params[key];
            updateCalculations();
        }

        // --- GESTIÓN DE LISTA ---
        function saveCurrentShape() {
            document.getElementById('save-modal').classList.remove('hidden');
            document.getElementById('shape-name-input').focus();
        }

        function closeModal() {
            document.getElementById('save-modal').classList.add('hidden');
        }

        function confirmSave() {
            const nameInput = document.getElementById('shape-name-input');
            const name = nameInput.value.trim() || `Shape ${savedShapes.length + 1}`;
            const newShape = {
                id: Date.now(),
                name: name,
                params: { ...params },
                material: document.getElementById('material-select').value
            };
            savedShapes.unshift(newShape);
            activeShapeId = newShape.id;
            saveToStorage();
            renderShapeList();
            updateUIState();
            closeModal();
            nameInput.value = '';
        }

        // FUNCIÓN CLAVE: Sobrescribir
        function overwriteCurrentShape() {
            if (!activeShapeId) return;
            
            const index = savedShapes.findIndex(s => s.id === activeShapeId);
            if (index !== -1) {
                savedShapes[index].params = { ...params };
                savedShapes[index].material = document.getElementById('material-select').value;
                
                saveToStorage();
                renderShapeList();
                
                // Feedback visual breve
                const btn = document.getElementById('btn-overwrite');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Guardado`;
                btn.classList.replace('bg-emerald-600', 'bg-emerald-500');
                lucide.createIcons();
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.replace('bg-emerald-500', 'bg-emerald-600');
                    lucide.createIcons();
                }, 1500);
            }
        }

        function loadShape(id) {
            const shape = savedShapes.find(s => s.id === id);
            if (shape) {
                params = { ...shape.params };
                activeShapeId = id;
                document.getElementById('material-select').value = shape.material || "1121.7";
                renderNumericControls();
                updateCalculations();
                renderShapeList();
                updateUIState();
            }
        }

        function updateUIState() {
            const overwriteBtn = document.getElementById('btn-overwrite');
            const editingIndicator = document.getElementById('editing-indicator');
            
            if (activeShapeId) {
                overwriteBtn.classList.remove('hidden');
                editingIndicator.classList.remove('hidden');
            } else {
                overwriteBtn.classList.add('hidden');
                editingIndicator.classList.add('hidden');
            }
        }

        function deleteShape(e, id) {
            e.stopPropagation();
            savedShapes = savedShapes.filter(s => s.id !== id);
            if (activeShapeId === id) activeShapeId = null;
            saveToStorage();
            renderShapeList();
            updateUIState();
        }

        function renameShape(e, id) {
            e.stopPropagation();
            const shape = savedShapes.find(s => s.id === id);
            const newName = prompt("Nuevo nombre del perfil:", shape.name);
            if (newName && newName.trim()) {
                shape.name = newName.trim();
                saveToStorage();
                renderShapeList();
            }
        }

        function renderShapeList() {
            const container = document.getElementById('shape-list');
            const count = document.getElementById('list-count');
            count.innerText = savedShapes.length;

            if (savedShapes.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-700 italic text-xs">No hay registros</div>`;
                return;
            }

            container.innerHTML = savedShapes.map(shape => `
                <div onclick="loadShape(${shape.id})" class="group p-4 rounded-2xl border border-white/5 bg-white/5 hover:bg-white/10 cursor-pointer transition-all ${activeShapeId === shape.id ? 'list-item-active ring-1 ring-blue-500/50' : ''}">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-bold text-slate-200 truncate pr-2">${shape.name}</span>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="renameShape(event, ${shape.id})" class="p-1.5 hover:bg-blue-500/10 rounded-lg"><i data-lucide="edit-2" class="w-3 h-3 text-blue-400"></i></button>
                            <button onclick="deleteShape(event, ${shape.id})" class="p-1.5 hover:bg-red-500/10 rounded-lg"><i data-lucide="x" class="w-3 h-3 text-red-400"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-5 gap-1">
                        ${Object.entries(shape.params).map(([k, v]) => `
                            <div class="flex flex-col">
                                <span class="text-[7px] text-slate-600 font-black">${k}</span>
                                <span class="text-[9px] font-mono text-slate-400">${v}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function saveToStorage() {
            localStorage.setItem('bonding_shoes_data_v2', JSON.stringify(savedShapes));
        }

        function loadFromStorage() {
            const data = localStorage.getItem('bonding_shoes_data_v2');
            if (data) {
                savedShapes = JSON.parse(data);
                renderShapeList();
            }
        }

        function updateCalculations() {
            const { A, B, C, D, E } = params;
            const density = parseFloat(document.getElementById('material-select').value);
            const L_NETA = 70; 

            const points = [[0, 0], [A, 0], [A, D], [E, B], [0, C]];
            
            let area = 0, cx = 0, cy = 0;
            for (let i = 0; i < points.length; i++) {
                const [x1, y1] = points[i];
                const [x2, y2] = points[(i + 1) % points.length];
                const factor = (x1 * y2 - x2 * y1);
                area += factor;
                cx += (x1 + x2) * factor;
                cy += (y1 + y2) * factor;
            }
            area = Math.abs(area) / 2;
            cx = (area !== 0) ? Math.abs(cx / (6 * area)) : 0;
            cy = (area !== 0) ? Math.abs(cy / (6 * area)) : 0;

            const volCm3 = (area * (L_NETA * 1000)) / 1000;
            const massKg = (volCm3 * (density / 1000)) / 1000;

            document.getElementById('m-area').innerText = area.toFixed(1);
            document.getElementById('m-mass').innerText = massKg.toFixed(3);

            document.getElementById('shapePoly').setAttribute('points', points.map(p => p.join(',')).join(' '));
            document.getElementById('centroid').setAttribute('cx', cx);
            document.getElementById('centroid').setAttribute('cy', cy);

            const svg = document.getElementById('svgMain');
            const pad = 50;
            const maxY = Math.max(B, C, D);
            svg.setAttribute('viewBox', `${-pad} ${-pad} ${A + pad * 2} ${maxY + pad * 2}`);
            drawCotas(A, B, C, D, E);
        }

        function drawCotas(A, B, C, D, E) {
            const group = document.getElementById('cotasGroup');
            group.innerHTML = '';
            const color = "rgba(148, 163, 184, 0.2)";
            const textColor = "#475569";

            const line = (x1, y1, x2, y2) => {
                const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                l.setAttribute("x1", x1); l.setAttribute("y1", y1);
                l.setAttribute("x2", x2); l.setAttribute("y2", y2);
                l.setAttribute("stroke", color); l.setAttribute("stroke-width", "0.8");
                return l;
            };

            const text = (x, y, txt) => {
                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.setAttribute("x", x); t.setAttribute("y", -y);
                t.setAttribute("fill", textColor);
                t.setAttribute("font-size", "7px");
                t.setAttribute("font-family", "'JetBrains Mono'");
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("transform", `scale(1, -1)`);
                t.textContent = txt;
                return t;
            };

            group.appendChild(line(0, -15, A, -15));
            group.appendChild(text(A/2, -22, `A: ${A}`));
            group.appendChild(line(-15, 0, -15, C));
            group.appendChild(text(-22, C/2, `C: ${C}`));
            group.appendChild(line(A + 15, 0, A + 15, D));
            group.appendChild(text(A + 22, D/2, `D: ${D}`));
            
            const picoRef = line(E, 0, E, B);
            picoRef.setAttribute("stroke-dasharray", "3,3");
            group.appendChild(picoRef);
            group.appendChild(text(E, B + 10, `B: ${B}`));
        }

        function toggleFullscreen() {
            const el = document.getElementById('main-display');
            const icon = document.getElementById('fs-icon');
            const isFS = el.classList.toggle('fullscreen-active');
            icon.setAttribute('data-lucide', isFS ? 'minimize' : 'maximize');
            lucide.createIcons();
            setTimeout(updateCalculations, 100);
        }

        window.onload = init;
    </script>
</body>
</html>